<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stock Price Anomaly Detection</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .container { max-width: 1100px; margin-top: 24px; }
      .loading { display: none; }
      .chart-card { height: 340px; }
      canvas { width: 100% !important; height: 100% !important; }
      .small-center { display:flex; justify-content:center; align-items:center; height:100%; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="mb-4 text-center">Stock Price Anomaly Detection</h1>

      <div class="card mb-3">
        <div class="card-body">
          <form id="uploadForm" class="row g-2 align-items-center">
            <div class="col-auto" style="flex:1 1 60%">
              <input class="form-control" type="file" id="file" name="file" accept=".csv" required>
            </div>
            <div class="col-auto">
              <button type="submit" class="btn btn-primary">Detect Anomalies</button>
            </div>
            <div class="col-12 mt-2">
              <div class="loading text-center" id="loading" style="display:none">
                <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                <div>Processing data...</div>
              </div>
              <div id="feedback" class="mt-2"></div>
            </div>
          </form>
        </div>
      </div>

      <div id="plots" class="mb-3" style="display:none">
        <div class="row g-3">
          <div class="col-md-7">
            <div class="card chart-card">
              <div class="card-body">
                <h5 class="card-title">EDA (up to 6 numeric columns)</h5>
                <canvas id="edaChart"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-5">
            <div class="card chart-card mb-3">
              <div class="card-body">
                <h5 class="card-title">Anomalies (recent)</h5>
                <canvas id="anomalyChart"></canvas>
              </div>
            </div>
            <div class="card" style="height:180px">
              <div class="card-body small-center">
                <div>
                  <h6 class="text-center">Anomaly Breakdown</h6>
                  <canvas id="pieChart" style="max-width:200px; margin:auto"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="results" style="display:none">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5>Detected Anomalies</h5>
          <div><strong>Total anomalies: <span id="anomalyCount">0</span></strong></div>
        </div>
        <div class="table-responsive">
          <table class="table table-striped" id="anomalyTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Open</th>
                <th>High</th>
                <th>Low</th>
                <th>Close</th>
                <th>Volume</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <script>
      const uploadForm = document.getElementById('uploadForm');
      const loadingEl = document.getElementById('loading');
      const feedback = document.getElementById('feedback');
      const plotsEl = document.getElementById('plots');
      const resultsEl = document.getElementById('results');

      let edaChart = null, anomalyChart = null, pieChart = null;

      uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        feedback.innerHTML = '';
        plotsEl.style.display = 'none';
        resultsEl.style.display = 'none';
        loadingEl.style.display = 'flex';

        const fileInput = document.getElementById('file');
        if (!fileInput.files || fileInput.files.length === 0) {
          loadingEl.style.display = 'none';
          feedback.innerHTML = '<div class="text-danger">Please select a CSV file.</div>';
          return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
          const resp = await fetch('/predict', { method: 'POST', body: formData });
          const data = await resp.json();
          if (!resp.ok || data.error) {
            const msg = data.error || (data.message || 'Server error');
            feedback.innerHTML = `<div class="text-danger">${msg}</div>`;
            loadingEl.style.display = 'none';
            return;
          }

          // draw charts if payloads exist
          if (data.eda && Array.isArray(data.eda.dates) && data.eda.dates.length > 0) {
            drawEda(data.eda);
            drawAnomaly(data.recent);
            drawPie(data.pie);
            plotsEl.style.display = 'block';
          } else {
            plotsEl.style.display = 'none';
          }

          // update table and count
          document.getElementById('anomalyCount').innerText = data.anomalies_count || 0;
          populateTable(data.anomalies || []);
          resultsEl.style.display = 'block';
          feedback.innerHTML = `<div class="text-success">${data.message || 'Done'}</div>`;

        } catch (err) {
          console.error(err);
          feedback.innerHTML = `<div class="text-danger">${err.message || 'Request failed'}</div>`;
        } finally {
          loadingEl.style.display = 'none';
        }
      });

      function drawEda(eda) {
        const ctx = document.getElementById('edaChart').getContext('2d');
        if (edaChart) edaChart.destroy();
        const datasets = eda.columns.map((col, i) => ({
          label: col,
          data: eda.series[col],
          borderColor: palette(i),
          backgroundColor: 'transparent',
          pointRadius: 0,
          tension: 0.15
        }));
        edaChart = new Chart(ctx, {
          type: 'line',
          data: { labels: eda.dates, datasets },
          options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { x: { display: true }, y: { display: true } } }
        });
      }

      function drawAnomaly(recent) {
        const ctx = document.getElementById('anomalyChart').getContext('2d');
        if (anomalyChart) anomalyChart.destroy();
        const closeDs = { label: 'Close', data: recent.close, borderColor: '#1f77b4', backgroundColor: 'transparent', pointRadius: 0, tension: 0.1 };
        const anomData = recent.close.map((v, i) => recent.flags[i] ? v : null);
        const anomDs = { label: 'Anomaly', data: anomData, pointBackgroundColor: '#ff4d4d', showLine: false, type: 'scatter', pointRadius: 5 };
        anomalyChart = new Chart(ctx, {
          data: { labels: recent.dates, datasets: [closeDs, anomDs] },
          options: { responsive: true, plugins: { legend: { display: true } }, scales: { x: { display: true }, y: { display: true } } }
        });
      }

      function drawPie(pie) {
        const ctx = document.getElementById('pieChart').getContext('2d');
        if (pieChart) pieChart.destroy();
        pieChart = new Chart(ctx, {
          type: 'pie',
          data: { labels: ['Normal','Anomaly'], datasets: [{ data: [pie.normal || 0, pie.anomalies || 0], backgroundColor: ['#66b3ff','#ff6666'] }] },
          options: { responsive: true }
        });
      }

      function populateTable(rows) {
        const tbody = document.querySelector('#anomalyTable tbody');
        tbody.innerHTML = '';
        rows.forEach(r => {
          const tr = document.createElement('tr');
          const date = r.Date || r.date || '';
          const open = formatNumber(r.Open);
          const high = formatNumber(r.High);
          const low = formatNumber(r.Low);
          const close = formatNumber(r.Close);
          const vol = r.Volume === undefined ? '' : r.Volume;
          tr.innerHTML = `<td>${date}</td><td>${open}</td><td>${high}</td><td>${low}</td><td>${close}</td><td>${vol}</td>`;
          tbody.appendChild(tr);
        });
      }

      function formatNumber(v) { return (v === null || v === undefined || isNaN(v)) ? '' : Number(v).toFixed(2); }

      function palette(i){ const p=['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b']; return p[i%p.length]; }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
